var Z=Object.create;var _=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var Y=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var ee=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of K(e))!Q.call(s,o)&&o!==t&&_(s,o,{get:()=>e[o],enumerable:!(a=V(e,o))||a.enumerable});return s};var M=(s,e,t)=>(t=s!=null?Z(J(s)):{},ee(e||!s||!s.__esModule?_(t,"default",{value:s,enumerable:!0}):t,s));var E=Y((R,D)=>{(function(s,e){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],e);else if(typeof R<"u")e(D);else{var t={exports:{}};e(t),s.browser=t.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:R,function(s){"use strict";if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let e="The message port closed before a response was received.",t=a=>{let o={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(o).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class A extends WeakMap{constructor(n,g=void 0){super(g),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}let d=r=>r&&typeof r=="object"&&typeof r.then=="function",b=(r,n)=>(...g)=>{a.runtime.lastError?r.reject(new Error(a.runtime.lastError.message)):n.singleCallbackArg||g.length<=1&&n.singleCallbackArg!==!1?r.resolve(g[0]):r.resolve(g)},k=r=>r==1?"argument":"arguments",z=(r,n)=>function(l,...m){if(m.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${k(n.minArgs)} for ${r}(), got ${m.length}`);if(m.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${k(n.maxArgs)} for ${r}(), got ${m.length}`);return new Promise((h,u)=>{if(n.fallbackToNoCallback)try{l[r](...m,b({resolve:h,reject:u},n))}catch(i){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),l[r](...m),n.fallbackToNoCallback=!1,n.noCallback=!0,h()}else n.noCallback?(l[r](...m),h()):l[r](...m,b({resolve:h,reject:u},n))})},F=(r,n,g)=>new Proxy(n,{apply(l,m,h){return g.call(m,r,...h)}}),C=Function.call.bind(Object.prototype.hasOwnProperty),v=(r,n={},g={})=>{let l=Object.create(null),m={has(u,i){return i in r||i in l},get(u,i,f){if(i in l)return l[i];if(!(i in r))return;let c=r[i];if(typeof c=="function")if(typeof n[i]=="function")c=F(r,r[i],n[i]);else if(C(g,i)){let w=z(i,g[i]);c=F(r,r[i],w)}else c=c.bind(r);else if(typeof c=="object"&&c!==null&&(C(n,i)||C(g,i)))c=v(c,n[i],g[i]);else if(C(g,"*"))c=v(c,n[i],g["*"]);else return Object.defineProperty(l,i,{configurable:!0,enumerable:!0,get(){return r[i]},set(w){r[i]=w}}),c;return l[i]=c,c},set(u,i,f,c){return i in l?l[i]=f:r[i]=f,!0},defineProperty(u,i,f){return Reflect.defineProperty(l,i,f)},deleteProperty(u,i){return Reflect.deleteProperty(l,i)}},h=Object.create(r);return new Proxy(h,m)},I=r=>({addListener(n,g,...l){n.addListener(r.get(g),...l)},hasListener(n,g){return n.hasListener(r.get(g))},removeListener(n,g){n.removeListener(r.get(g))}}),G=new A(r=>typeof r!="function"?r:function(g){let l=v(g,{},{getContent:{minArgs:0,maxArgs:0}});r(l)}),N=new A(r=>typeof r!="function"?r:function(g,l,m){let h=!1,u,i=new Promise(S=>{u=function(x){h=!0,S(x)}}),f;try{f=r(g,l,u)}catch(S){f=Promise.reject(S)}let c=f!==!0&&d(f);if(f!==!0&&!c&&!h)return!1;let w=S=>{S.then(x=>{m(x)},x=>{let L;x&&(x instanceof Error||typeof x.message=="string")?L=x.message:L="An unexpected error occurred",m({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(x=>{console.error("Failed to send onMessage rejected reply",x)})};return w(c?f:i),!0}),H=({reject:r,resolve:n},g)=>{a.runtime.lastError?a.runtime.lastError.message===e?n():r(new Error(a.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?r(new Error(g.message)):n(g)},W=(r,n,g,...l)=>{if(l.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${k(n.minArgs)} for ${r}(), got ${l.length}`);if(l.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${k(n.maxArgs)} for ${r}(), got ${l.length}`);return new Promise((m,h)=>{let u=H.bind(null,{resolve:m,reject:h});l.push(u),g.sendMessage(...l)})},X={devtools:{network:{onRequestFinished:I(G)}},runtime:{onMessage:I(N),onMessageExternal:I(N),sendMessage:W.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:W.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},O={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return o.privacy={network:{"*":O},services:{"*":O},websites:{"*":O}},v(a,X,o)};s.exports=t(chrome)}else s.exports=globalThis.browser})});var p=M(E());var y=M(E()),U=M(E()),se=class{constructor(s){this.stateManager=s,this.ports={},this.onInstanceConnectListener=()=>{},this.instanceDisconnectListener=()=>{},U.default.runtime.onConnect.addListener(e=>{e.name==="weirwood"&&(console.log("Porter, heard port connect to weirwood. port tabId: ",e.sender.tab.id),this.addPort(e),this.sendStateUpdate(e.sender.tab.id))})}addPort(s){console.log("Porter, adding port: ",s);let e=s.sender.tab.id,t=s.sender.frameId;if(this.ports[e]&&this.ports[e].hasOwnProperty(t)){console.log("Porter, tabId already exists. Ignoring add request.");return}this.ports[e]?this.ports[e][t]=s:this.ports[e]={[t]:s},console.log("Porter, added port. Ports: ",this.ports),s.onMessage.addListener(a=>this.handleMessage(e,a)),s.onDisconnect.addListener(()=>{console.log("Ports disconnected. tabId: ",e),delete this.ports[e],this.instanceDisconnectListener(s)}),this.onInstanceConnectListener(s)}onInstanceConnect(s){this.onInstanceConnectListener=s}onInstanceDisconnect(s){this.instanceDisconnectListener=s}handleMessage(s,e){e.type==="setState"&&(console.log("handleMessage, setState"),this.stateManager.set(e.state,s)),e.type==="setInstanceState"&&(console.log("handleMessage, setInstanceState"),this.stateManager.set(e.state,e.tabId))}sendStateUpdate(s){this.ports[s]?(console.log("sendStateUpdate: tab",s," state: ",this.stateManager.get(s)),Object.keys(this.ports[s]).forEach(e=>{this.ports[s][Number(e)].postMessage({type:"stateUpdate",state:{...this.stateManager.get(s)}})})):console.log("sendStateUpdate: No port for tabId: ",s," yet.")}broadcastStateUpdate(s){console.log("Broadcasting state update"),Object.keys(this.ports).forEach(e=>{this.sendStateUpdate(Number(e))})}},te=class{constructor(s,e){this.config=s,this.onStateChangeListeners=[],this.instanceConnectListener=()=>{},this.instanceDisconnectListener=()=>{},this.STORAGE_PREFIX="ww_",console.log("Weirwood constructor called."),this.defaultInstanceState=this.instanceStates=this.initializeInstanceDefault(),this.defaultWorkerState=this.workerState=this.initializeWorkerDefault(),this.hydrate(),this.porter=new se(this),this.porter.onInstanceConnect(t=>{let a=this.instanceConnectListener(t,this.instanceStates,this.workerState),o=t.sender.tab.id;this.addInstance(o,a),t.onDisconnect.addListener(()=>{this.removeInstance(o),this.instanceDisconnectListener(t,this.instanceStates,this.workerState)})}),e&&(this.STORAGE_PREFIX=e),this.subscribe(t=>{console.log("State change detected. Broadcasting state update. changes: ",t),this.porter.broadcastStateUpdate(this.get())})}get(s){return s?{...this.workerState,...this.instanceStates[s]}:{...this.workerState}}async set(s,e){console.log("Weirwood.set, state: ",s," tabId: ",e);let t={},a={};for(let o in s){let A=this.config[o];if(A.partition==="instance"){let d=o,b=s;t[d]=b[d]}else if(!A.partition||A.partition==="worker"){let d=o,b=s;a[d]=b[d]}}e&&this.setInstanceState(e,t),this.setWorkerState(a)}async setWorkerState(s){console.log("setWorkerState, update: ",s);let e={...this.workerState,...s};this.deepEqual(this.workerState,e)||(this.workerState=e,await this.persist(s),this.notify(s))}async setInstanceState(s,e){console.log("setInstanceState");let t={...this.defaultInstanceState,...this.instanceStates[s],...e};this.deepEqual(this.instanceStates[s],t)||(this.instanceStates[s]=t,this.notify(e,s))}async clear(){this.workerState=this.defaultWorkerState,this.instanceStates={},await this.persist(),this.notify({})}subscribe(s){this.onStateChangeListeners.push(s)}notify(s,e){this.onStateChangeListeners.forEach(t=>t(s,e))}async addInstance(s,e){if(!this.instanceStates.hasOwnProperty(s)){let t={...this.defaultInstanceState};e&&(t.context={...e}),console.log("Adding tab. new instance state: ",t),this.instanceStates[s]=t}}onInstanceConnect(s){this.instanceConnectListener=s}onInstanceDisconnect(s){this.instanceDisconnectListener=s}async removeInstance(s){this.instanceStates.hasOwnProperty(s)&&delete this.instanceStates[s]}async persist(s){for(let e in s||this.workerState){let t=this.config[e].persistance||"none",a=s?s[e]:this.workerState[e];switch(console.log("Persisting: ",e,a," persistence: ",t),t){case"session":await y.default.storage.session.set({[this.STORAGE_PREFIX+e]:a});break;case"local":await y.default.storage.local.set({[this.STORAGE_PREFIX+e]:a});break;default:break}}}async hydrate(){console.log("Hydrating");let s=await y.default.storage.local.get(null),e=await y.default.storage.session.get(null);console.log("session: ",e);let t={...s,...e},a={};for(let o in t){let A=this.removePrefix(o);if(this.config.hasOwnProperty(A)){let d=t[A];a[A]=d}}this.workerState={...this.defaultWorkerState,...a}}getDefaultStates(){return console.log("Getting default states."),{...this.defaultWorkerState,...this.defaultInstanceState}}initializeInstanceDefault(){let s={};return Object.keys(this.config).forEach(e=>{let t=this.config[e];t.partition==="instance"&&(s[e]=t.default)}),s}initializeWorkerDefault(){let s={};return Object.keys(this.config).forEach(e=>{let t=this.config[e];t.partition==="worker"&&(s[e]=t.default)}),s}removePrefix(s){return s.startsWith(this.STORAGE_PREFIX)?s.replace(this.STORAGE_PREFIX,""):s}deepEqual(s,e){if(s===e)return!0;if(s==null||typeof s!="object"||e==null||typeof e!="object")return!1;let t=Object.keys(s),a=Object.keys(e);if(t.length!==a.length)return!1;t.sort(),a.sort();for(let o=0;o<t.length;o++){let A=t[o];if(A!==a[o]||!this.deepEqual(s[A],e[A]))return!1}return!0}};function $(s,e){return new te(s,e)}var P=class{constructor(){}async handleFetchRequest(e){try{let t=await fetch(e.url,{method:e.method,headers:e.headers,body:e.body});if(t.ok){let a=await t.json();if(e.type==="card")return a}else console.error("HTTP request failed:",t.status)}catch(t){console.error("Error occurred during HTTP request:",t)}}};var T="session";var q="instance",B={stats:{default:{active:0,open:0},persistance:T},version:{default:"",persistance:T},magicCard:{default:null,persistance:T},ports:{default:[],persistance:T},isOpen:{default:!1,partition:q},initialized:{default:"",partition:q}};var j=class{constructor(){console.log("Hello"),console.log("background script constructor called"),console.log("Performance measurement started."),this.httpService=new P,this.weirwood=$(B),this.weirwood.onInstanceConnect((e,t,a)=>{let o=e.sender.tab.id,A=e.sender.tab.url;return this.weirwood.set({ports:Object.keys(t).map(d=>Number(d))}),this.weirwood.set({stats:{active:Object.keys(t).length,open:Object.keys(t).filter(d=>t[Number(d)].isOpen).length}}),{tabUrl:A,tabId:o,initialized:new Date().getTime().toString()}}),this.weirwood.onInstanceDisconnect((e,t,a)=>{this.weirwood.set({ports:Object.keys(t).map(o=>Number(o))}),this.weirwood.set({stats:{active:Object.keys(t).length,open:Object.keys(t).filter(o=>t[Number(o)].isOpen).length}})}),this.weirwood.subscribe(e=>{if(e.hasOwnProperty("isOpen")){let{stats:t}=this.weirwood.get(),a=e.isOpen?t.open+1:t.open-1,o={...t,open:a};this.weirwood.set({stats:o})}}),this.establishListeners()}establishListeners(){p.default.action.onClicked.addListener(e=>{p.default.tabs.sendMessage(e.id,{type:"toggleApp"})}),p.default.runtime.onConnect.addListener(e=>{e.name==="fetchChannel"&&(console.log("Connecting fetchChannel"),e.onMessage.addListener(t=>{console.log("Fetch request heard: ",t),this.httpService.handleFetchRequest(t).then(a=>{if(a){let o={flavor_name:a.flavor_name,colors:a.colors,image_uris:{normal:a.image_uris.normal},name:a.name,power:a.power,toughness:a.toughness};this.weirwood.set({magicCard:o})}})}))}),p.default.runtime.onInstalled.addListener(e=>{console.log("onInstalled listener heard. details: ",e),e.reason==="install"&&this.weirwood.clear(),e.reason==="update"&&this.weirwood.clear()}),p.default.runtime.onStartup.addListener(()=>{console.log("onStartup listener heard.")}),p.default.runtime.onSuspend.addListener(()=>{console.log("onSuspend listener heard.")}),p.default.runtime.onSuspendCanceled.addListener(()=>{console.log("onSuspendCanceled listener heard.")}),p.default.runtime.onUpdateAvailable.addListener(()=>{console.log("onUpdateAvailable listener heard.")})}};new j;
//# sourceMappingURL=background.js.map
